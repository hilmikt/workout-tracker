<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Local Gym Workout Tracker</title>
  <style>
    :root{
      --bg: #0b0f14;
      --card: #111827;
      --muted: #9aa4b2;
      --text: #e5e7eb;
      --accent: #3b82f6;
      --accent-2: #22c55e;
      --danger: #ef4444;
      --warn: #f59e0b;
      --shadow: 0 10px 25px rgba(0,0,0,.25);
      --radius: 16px;
      --ease: cubic-bezier(.2,.8,.2,1);
      --ease-bounce: cubic-bezier(.2, 1.2, .2, 1);
      --anim-fast: .18s;
      --anim: .32s;
      --anim-slow: .6s;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:linear-gradient(180deg,#0a0e13,#0b1220 40%,#0d1930);color:var(--text)}

    /* ---------- Animations ---------- */
    @media (prefers-reduced-motion: no-preference){
      .reveal{opacity:0; transform: translateY(8px); animation: fadeUp var(--anim) var(--ease) forwards}
      .pop{opacity:0; transform: scale(.98); animation: popIn var(--anim) var(--ease) forwards}
      .pulse{animation: pulse 1.8s ease-in-out infinite}
      @keyframes fadeUp{to{opacity:1; transform: translateY(0)}}
      @keyframes popIn{to{opacity:1; transform: scale(1)}}
      @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
      @keyframes ripple{from{transform:scale(0);opacity:.35} to{transform:scale(18);opacity:0}}
    }

    .container{max-width:1100px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;z-index:20;background:rgba(11,15,20,.7);backdrop-filter: blur(8px);border-bottom:1px solid rgba(255,255,255,.06)}
    header .container{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .logo{display:flex;align-items:center;gap:10px}
    .logo-badge{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#60a5fa);display:grid;place-items:center;box-shadow: var(--shadow)}
    .logo-badge svg{filter:drop-shadow(0 2px 8px rgba(59,130,246,.7))}
    h1{font-size: clamp(18px, 5vw, 24px); margin: 10px 0}
    .grid{display:grid;gap:14px}
    @media(min-width:900px){.grid-cols-2{grid-template-columns:1.2fr .8fr}}
    .card{background:linear-gradient(180deg,#0e1622,#0b1220); border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:var(--shadow)}
    .card.reveal{animation-delay:.05s}
    .card-header{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .card-body{padding:14px}
    .muted{color:var(--muted)}
    .btn{appearance:none;border:none;cursor:pointer;border-radius:12px;padding:10px 14px;font-weight:600;color:#0b0f14;background:var(--text);transition:transform var(--anim-fast) var(--ease),opacity var(--anim-fast) var(--ease),box-shadow var(--anim-fast) var(--ease); position:relative; overflow:hidden}
    .btn:hover{opacity:.95; box-shadow: 0 4px 14px rgba(0,0,0,.25)}
    .btn:active{transform:translateY(1px) scale(.99)}
    .btn.primary{background:var(--accent);color:white}
    .btn.success{background:var(--accent-2);color:white}
    .btn.warn{background:var(--warn);color:#0b0f14}
    .btn.ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.15)}
    .btn.danger{background:var(--danger);color:white}
    .btn.small{padding:8px 10px}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .grow{flex:1;min-width:0}
    input, select, textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0b1422;color:var(--text);font-size:14px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    .section-title{font-weight:700;margin:0 0 8px 0}

    /* ---------- Categories ---------- */
    .category-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media(min-width:640px){.category-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .category-card{padding:14px;border-radius:14px;background:linear-gradient(180deg,#101827,#0b1424);border:1px solid rgba(255,255,255,.06); transform:translateY(0); transition: transform var(--anim) var(--ease), box-shadow var(--anim) var(--ease)}
    .category-card:hover{transform: translateY(-3px); box-shadow: 0 12px 24px rgba(0,0,0,.25)}
    .category-card h3{margin:0 0 6px 0;font-size:14px}
    .category-card p{margin:0 0 12px 0;font-size:12px;color:var(--muted)}

    /* ---------- Calendar ---------- */
    .calendar{user-select:none}
    .cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .cal-grid{display:grid;grid-template-columns:repeat(7, minmax(40px,1fr));gap:6px}
    @media(max-width:380px){.cal-grid{gap:4px}}
    .dow{font-size:12px;color:var(--muted);text-align:center;padding:6px 0}
    .day{border:1px solid rgba(255,255,255,.06);aspect-ratio:1;border-radius:12px;display:flex;flex-direction:column;align-items:flex-start;justify-content:flex-start;padding:6px;position:relative;background:linear-gradient(180deg,#0f1624,#0b1424); transition: transform var(--anim-fast) var(--ease), outline var(--anim-fast) var(--ease)}
    .day:active{transform: scale(.98)}
    .day button{all:unset;position:absolute;inset:0;cursor:pointer;border-radius:12px}
    .day .date{font-size:12px;color:var(--muted)}
    .day .dots{margin-top:auto;display:flex;gap:4px;flex-wrap:wrap}
    .dot{width:6px;height:6px;border-radius:50%;background:var(--accent)}
    .dot.leg{background:#a78bfa}
    .dot.arm{background:#f43f5e}
    .dot.back{background:#22d3ee}
    .dot.forearm{background:#f59e0b}
    .dot.shoulder{background:#10b981}
    .selected{outline:2px solid var(--accent); transform: scale(1.02)}

    .day-details .workout-item{border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;margin-bottom:10px;background:linear-gradient(180deg,#0f1828,#0b1424)}
    .workout-header{display:flex;align-items:center;justify-content:space-between}
    .set-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .set-grid .set{border:1px dashed rgba(255,255,255,.12);border-radius:10px;padding:8px;text-align:center}

    /* ---------- Modal (animated) ---------- */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;padding:16px;z-index:100; opacity:0;visibility:hidden; pointer-events:none; transition: opacity var(--anim) var(--ease)}
    .modal.open{opacity:1;visibility:visible; pointer-events:auto}
    .modal .panel{width:min(900px,100%);max-height:90vh;overflow:auto;background:linear-gradient(180deg,#0e1622,#0b1220);border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:var(--shadow); transform: translateY(8px) scale(.98); opacity:0; transition: transform var(--anim) var(--ease), opacity var(--anim) var(--ease)}
    .modal.open .panel{transform: translateY(0) scale(1); opacity:1}
    .modal .panel .head{position:sticky;top:0;background:rgba(14,22,34,.9);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:space-between;padding:14px;border-bottom:1px solid rgba(255,255,255,.08)}
    .modal .panel .content{padding:14px}
    .exercise-row{border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;margin-bottom:12px;background:linear-gradient(180deg,#0f1828,#0b1424)}
    .exercise-head{display:flex;align-items:center;gap:10px;justify-content:space-between;margin-bottom:10px}
    .exercise-name{font-weight:700}
    .set-table{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .set-cell{display:grid;grid-template-columns:1fr 1fr;gap:6px}
    .footer-actions{position:sticky;bottom:0;background:rgba(14,22,34,.9);backdrop-filter:blur(8px);display:flex;gap:10px;justify-content:flex-end;padding:12px;border-top:1px solid rgba(255,255,255,.08)}

    /* ---------- Manage ---------- */
    details.manage{border:1px solid rgba(255,255,255,.08);border-radius:12px}
    details.manage summary{cursor:pointer;list-style:none;padding:12px 14px}
    details.manage[open] summary{border-bottom:1px solid rgba(255,255,255,.08)}
    .exercise-list{display:flex;flex-wrap:wrap;gap:10px;padding:12px}
    .exercise-pill{display:flex;align-items:center;gap:8px;padding:8px 10px;background:#0f172a;border:1px solid rgba(255,255,255,.08);border-radius:999px;font-size:12px}

    .small{font-size:12px}
    .right{margin-left:auto}

    /* ---------- Toasts ---------- */
    .toasts{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);display:grid;gap:8px;z-index:120}
    .toast{background:#0f172a;border:1px solid rgba(255,255,255,.12);color:#e5e7eb;padding:10px 12px;border-radius:12px;box-shadow:var(--shadow);opacity:0;transform:translateY(8px); transition: opacity var(--anim) var(--ease), transform var(--anim) var(--ease)}
    .toast.show{opacity:1; transform:translateY(0)}
    .toast.success{border-color:rgba(34,197,94,.4)}
    .toast.error{border-color:rgba(239,68,68,.5)}

  </style>
</head>
<body>
  <header class="reveal">
    <div class="container">
      <div class="logo">
        <div class="logo-badge pulse" aria-hidden="true">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 12h16M7 7h10M7 17h10" stroke="white" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <h1>Workout Tracker (Local Â· Offline)</h1>
          <div class="muted small">No database. Optional GitHub auto-backup.</div>
        </div>
      </div>
      <div class="right row">
        <button id="exportBtn" class="btn ghost small">Export JSON</button>
        <label for="importFile" class="btn ghost small" style="cursor:pointer">Import</label>
        <input id="importFile" type="file" accept="application/json" hidden />
        <button id="syncBtn" class="btn small">Sync Now</button>
        <button id="settingsBtn" class="btn ghost small">Settings</button>
        <button id="resetBtn" class="btn danger small">Reset All</button>
      </div>
    </div>
  </header>

  <main class="container grid grid-cols-2" style="margin-top:12px">
    <!-- Left: Quick actions & calendar -->
    <section class="card reveal">
      <div class="card-header">
        <div>
          <div class="section-title">Quick Start</div>
          <div class="muted small">Pick a muscle group and hit <strong>Start Workout</strong>. Last session auto-fills.</div>
        </div>
      </div>
      <div class="card-body">
        <div class="category-grid" id="categoryGrid"></div>
      </div>
      <div class="card-header">
        <div class="section-title">Calendar</div>
        <div class="row">
          <button id="prevMonth" class="btn ghost small">â</button>
          <button id="todayBtn" class="btn ghost small">Today</button>
          <button id="nextMonth" class="btn ghost small">â¶</button>
        </div>
      </div>
      <div class="card-body calendar">
        <div class="cal-header">
          <div id="monthLabel" style="font-weight:700"></div>
        </div>
        <div class="cal-grid" id="calGrid"></div>
      </div>
    </section>

    <!-- Right: Day details & manage -->
    <section class="card reveal">
      <div class="card-header">
        <div>
          <div class="section-title">Day Details</div>
          <div class="muted small" id="selectedDateLabel">Select a day</div>
        </div>
        <div class="row">
          <input type="date" id="datePicker" />
          <button id="addQuickBtn" class="btn small">Quick Add</button>
        </div>
      </div>
      <div class="card-body day-details" id="dayDetails"></div>

      <div class="card-header">
        <div class="section-title">Manage Exercises</div>
        <div class="muted small">Add or remove exercises by group. These are templates for future sessions.</div>
      </div>
      <div class="card-body" id="manageArea"></div>
    </section>
  </main>

  <!-- Workout Modal -->
  <div class="modal" id="workoutModal" aria-hidden="true">
    <div class="panel">
      <div class="head">
        <div>
          <div class="section-title" id="modalTitle">Start Workout</div>
          <div class="muted small" id="lastSessionInfo">Last session: â</div>
        </div>
        <div class="row">
          <input type="date" id="modalDate" />
          <button class="btn ghost" id="closeModal">Close</button>
        </div>
      </div>
      <div class="content">
        <div class="row" style="margin-bottom:12px">
          <div class="grow"></div>
          <input id="newExerciseName" placeholder="Add new exercise nameâ¦" />
          <button id="addExerciseBtn" class="btn">Add Exercise</button>
        </div>
        <div id="exerciseContainer"></div>
      </div>
      <div class="footer-actions">
        <button id="deleteSessionBtn" class="btn danger" title="Delete this date's session for this group">Delete This Session</button>
        <button id="saveWorkoutBtn" class="btn success">Save Workout</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal (GitHub Sync) -->
  <div class="modal" id="settingsModal" aria-hidden="true">
    <div class="panel">
      <div class="head">
        <div>
          <div class="section-title">GitHub Sync Settings</div>
          <div class="muted small">Push a JSON backup to a repo file and load from it on any device.</div>
        </div>
        <div class="row">
          <button class="btn ghost" id="closeSettings">Close</button>
        </div>
      </div>
      <div class="content">
        <div class="settings-grid">
          <div>
            <label>Owner (your GitHub username)</label>
            <input id="ghOwner" placeholder="your-username" />
          </div>
          <div>
            <label>Repo name</label>
            <input id="ghRepo" placeholder="workout-tracker" />
          </div>
          <div>
            <label>Branch</label>
            <input id="ghBranch" placeholder="main" />
          </div>
          <div>
            <label>File path in repo</label>
            <input id="ghPath" placeholder="backup.json" />
          </div>
          <div>
            <label>Personal Access Token (fine-grained, contents:write)</label>
            <input id="ghToken" placeholder="ghp_â¦" />
          </div>
          <div>
            <label>Auto-sync on save</label>
            <select id="ghAuto"><option value="off">Off</option><option value="on">On</option></select>
          </div>
        </div>
        <div style="margin-top:12px" class="muted small">
          Security: Token is stored only in this browser's localStorage and used directly against GitHub's API over HTTPS. Exports from this app never include your token.
        </div>
      </div>
      <div class="footer-actions">
        <button id="saveSettings" class="btn success">Save Settings</button>
        <button id="loadFromGitHub" class="btn">Load From GitHub</button>
      </div>
    </div>
  </div>

  <div class="toasts" id="toasts" aria-live="polite" aria-atomic="true"></div>

  <template id="categoryCardTpl">
    <div class="category-card pop">
      <h3></h3>
      <p>Templates: <span class="muted ex-count">0</span></p>
      <div class="row">
        <button class="btn primary start-btn">Start Workout</button>
        <button class="btn ghost edit-btn">Manage</button>
      </div>
    </div>
  </template>

  <script>
    // ====== Data Model & Storage ======
    const CATEGORIES = ["Chest","Back","Arms","Shoulders","Legs","Forearms"]; // unique
    const STORE_KEY = "gymTracker.v1";
    const SETTINGS_KEY = "gymTracker.settings"; // owner, repo, branch, path, auto
    const TOKEN_KEY = "gymTracker.token";       // stored separately

    const initialState = () => ({
      exercises: Object.fromEntries(CATEGORIES.map(c => [c, defaultExercises(c)])),
      workouts: {}, // dateKey -> [ { category, items:[{ id,name, sets:[{weight,reps}x3], note}] } ]
    });

    function defaultExercises(cat){
      switch(cat){
        case 'Chest': return ["Bench Press","Incline DB Press","Cable Fly"].map(n=>makeEx(n));
        case 'Back': return ["Deadlift","Lat Pulldown","Seated Row"].map(n=>makeEx(n));
        case 'Arms': return ["Barbell Curl","Tricep Pushdown","Hammer Curl"].map(n=>makeEx(n));
        case 'Shoulders': return ["Overhead Press","Lateral Raise","Rear Delt Fly"].map(n=>makeEx(n));
        case 'Legs': return ["Squat","Leg Press","Romanian Deadlift"].map(n=>makeEx(n));
        case 'Forearms': return ["Wrist Curl","Reverse Curl","Farmer's Carry"].map(n=>makeEx(n));
        default: return [];
      }
    }

    function makeEx(name){ return { id: "ex_"+Math.random().toString(36).slice(2,9), name }; }

    function load(){
      try{
        const raw = localStorage.getItem(STORE_KEY);
        if(!raw) return initialState();
        const parsed = JSON.parse(raw);
        for(const c of CATEGORIES){ if(!parsed.exercises[c]) parsed.exercises[c] = []; }
        return parsed;
      }catch(e){ console.warn('Failed to load, resetting', e); return initialState(); }
    }
    function save(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); renderAll(); maybeAutoSync(); }

    function loadSettings(){
      try{ return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || { owner:'', repo:'', branch:'main', path:'backup.json', auto:'off' }; }
      catch{ return { owner:'', repo:'', branch:'main', path:'backup.json', auto:'off' }; }
    }
    function saveSettings(s){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }
    function getToken(){ return localStorage.getItem(TOKEN_KEY)||''; }
    function setToken(t){ localStorage.setItem(TOKEN_KEY, t||''); }

    // ====== Global State ======
    let state = load();
    let settings = loadSettings();
    let ui = {
      currentMonth: (()=>{ const d=new Date(); return new Date(d.getFullYear(), d.getMonth(), 1); })(),
      selectedDate: dateKey(new Date()),
      modalCategory: null,
      modalItems: [],
    };

    // ====== Utilities ======
    function pad(n){return n<10?"0"+n:""+n}
    function dateKey(d){ if(typeof d === 'string') return d; return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
    function parseKey(key){ const [y,m,dd] = key.split('-').map(Number); return new Date(y, m-1, dd); }
    function clone(x){ return JSON.parse(JSON.stringify(x)); }
    function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1).toLowerCase(); }
    function escapeHtml(s){ return (s||'').replace(/[&<>"]+/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }
    function cssEscape(s){ return s.replace(/[^a-z0-9]/gi,'-'); }

    // ====== Calendar Rendering ======
    const calGrid = document.getElementById('calGrid');
    const monthLabel = document.getElementById('monthLabel');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const todayBtn = document.getElementById('todayBtn');

    prevMonthBtn.onclick = ()=>{ ui.currentMonth = new Date(ui.currentMonth.getFullYear(), ui.currentMonth.getMonth()-1, 1); renderCalendar(); };
    nextMonthBtn.onclick = ()=>{ ui.currentMonth = new Date(ui.currentMonth.getFullYear(), ui.currentMonth.getMonth()+1, 1); renderCalendar(); };
    todayBtn.onclick = ()=>{ const d=new Date(); ui.currentMonth=new Date(d.getFullYear(), d.getMonth(),1); ui.selectedDate=dateKey(d); renderAll(); };

    function renderCalendar(){
      const y = ui.currentMonth.getFullYear();
      const m = ui.currentMonth.getMonth();
      monthLabel.textContent = ui.currentMonth.toLocaleString(undefined,{month:'long', year:'numeric'});
      calGrid.innerHTML = '';
      const dowNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      dowNames.forEach(d=>{ const div=document.createElement('div');div.className='dow';div.textContent=d;calGrid.appendChild(div); });
      const firstDow = new Date(y,m,1).getDay();
      const daysInMonth = new Date(y,m+1,0).getDate();
      for(let i=0;i<firstDow;i++){ const s=document.createElement('div'); calGrid.appendChild(s); }
      for(let day=1; day<=daysInMonth; day++){
        const key = `${y}-${pad(m+1)}-${pad(day)}`;
        const cell = document.createElement('div');
        cell.className = 'day'+(key===ui.selectedDate?' selected':'');
        const span = document.createElement('div'); span.className='date'; span.textContent=day; cell.appendChild(span);
        const dots = document.createElement('div'); dots.className='dots';
        const ws = state.workouts[key]||[];
        const cats = [...new Set(ws.map(w=>w.category))];
        cats.forEach(c=>{ const dot=document.createElement('div'); dot.className='dot '+dotClass(c); dots.appendChild(dot); });
        cell.appendChild(dots);
        const btn=document.createElement('button'); btn.onclick=()=>{ ui.selectedDate=key; renderAll(); };
        cell.appendChild(btn);
        calGrid.appendChild(cell);
      }
    }

    function dotClass(c){
      switch(c){ case 'Legs': return 'leg'; case 'Arms': return 'arm'; case 'Back': return 'back'; case 'Forearms': return 'forearm'; case 'Shoulders': return 'shoulder'; default: return ''; }
    }

    // ====== Day Details ======
    const dayDetails = document.getElementById('dayDetails');
    const selectedDateLabel = document.getElementById('selectedDateLabel');
    const datePicker = document.getElementById('datePicker');

    datePicker.onchange = (e)=>{ ui.selectedDate = e.target.value; renderAll(); };

    function renderDay(){
      selectedDateLabel.textContent = new Date(parseKey(ui.selectedDate)).toLocaleDateString(undefined,{weekday:'short', month:'short', day:'numeric', year:'numeric'});
      datePicker.value = ui.selectedDate;
      dayDetails.innerHTML = '';
      const ws = state.workouts[ui.selectedDate] || [];
      if(ws.length===0){ const p=document.createElement('div'); p.className='muted'; p.textContent='No workouts logged for this day.'; dayDetails.appendChild(p); return; }
      ws.forEach((w, idx)=>{
        const wrap=document.createElement('div'); wrap.className='workout-item reveal';
        const h=document.createElement('div'); h.className='workout-header';
        const t=document.createElement('div'); t.innerHTML = `<strong>${w.category}</strong> Â· ${w.items.length} exercise(s)`; h.appendChild(t);
        const row=document.createElement('div'); row.className='row';
        const editBtn=document.createElement('button'); editBtn.className='btn ghost small'; editBtn.textContent='Edit'; editBtn.onclick=()=>openModal(w.category, ui.selectedDate);
        const delBtn=document.createElement('button'); delBtn.className='btn danger small'; delBtn.textContent='Delete'; delBtn.onclick=()=>{ if(confirm('Delete this workout?')){ state.workouts[ui.selectedDate].splice(idx,1); if(state.workouts[ui.selectedDate].length===0) delete state.workouts[ui.selectedDate]; save(); notify('Session deleted','success'); } };
        row.appendChild(editBtn); row.appendChild(delBtn); h.appendChild(row);
        wrap.appendChild(h);
        w.items.forEach(it=>{
          const ex=document.createElement('div'); ex.style.marginTop='8px';
          const title=document.createElement('div'); title.innerHTML=`<strong>${it.name}</strong> <span class='muted small'>${it.note?('Â· '+escapeHtml(it.note)):' '}</span>`; ex.appendChild(title);
          const sets=document.createElement('div'); sets.className='set-grid';
          it.sets.forEach((s,i)=>{
            const d=document.createElement('div'); d.className='set'; d.innerHTML=`<div class='small muted'>Set ${i+1}</div><div><strong>${s.weight||0} kg Ã ${s.reps||0}</strong></div>`; sets.appendChild(d);
          });
          ex.appendChild(sets); wrap.appendChild(ex);
        });
        dayDetails.appendChild(wrap);
      });
    }

    // ====== Categories (Quick Start) ======
    const categoryGrid = document.getElementById('categoryGrid');
    const categoryCardTpl = document.getElementById('categoryCardTpl');

    function renderCategories(){
      categoryGrid.innerHTML='';
      CATEGORIES.forEach((cat, i)=>{
        const node = categoryCardTpl.content.cloneNode(true);
        const card = node.querySelector('.category-card');
        card.style.animationDelay = (i*60)+'ms';
        node.querySelector('h3').textContent = cat;
        node.querySelector('.ex-count').textContent = state.exercises[cat]?.length ?? 0;
        node.querySelector('.start-btn').onclick = ()=> openModal(cat);
        node.querySelector('.edit-btn').onclick = ()=> scrollToManage(cat);
        categoryGrid.appendChild(node);
      });
    }

    function scrollToManage(cat){
      const det = document.querySelector(`details.manage[data-cat="${cssEscape(cat)}"]`);
      if(det){ det.open = true; det.scrollIntoView({behavior:'smooth', block:'start'}); }
    }

    // ====== Manage Exercises ======
    const manageArea = document.getElementById('manageArea');

    function renderManage(){
      manageArea.innerHTML='';
      CATEGORIES.forEach(cat=>{
        const d=document.createElement('details'); d.className='manage reveal'; d.dataset.cat = cat;
        const s=document.createElement('summary'); s.innerHTML = `<strong>${cat}</strong>`; d.appendChild(s);
        const box=document.createElement('div');
        const list=document.createElement('div'); list.className='exercise-list';
        (state.exercises[cat]||[]).forEach(ex=>{
          const pill=document.createElement('div'); pill.className='exercise-pill';
          pill.innerHTML = `<span>${ex.name}</span>`;
          const del=document.createElement('button'); del.className='btn danger small'; del.textContent='Ã'; del.title='Delete exercise template';
          del.onclick=()=>{ if(confirm('Delete this exercise from templates?')){ state.exercises[cat] = state.exercises[cat].filter(e=>e.id!==ex.id); save(); notify('Exercise removed','success'); } };
          pill.appendChild(del); list.appendChild(pill);
        });
        const row=document.createElement('div'); row.className='row';
        const inp=document.createElement('input'); inp.placeholder='Add new exercise nameâ¦'; inp.onkeydown=(e)=>{ if(e.key==='Enter'){ addTemplate(cat, inp.value.trim()); inp.value=''; } };
        const add=document.createElement('button'); add.className='btn'; add.textContent='Add'; add.onclick=()=>{ addTemplate(cat, inp.value.trim()); inp.value=''; };
        row.appendChild(inp); row.appendChild(add);
        box.appendChild(list); box.appendChild(row); box.style.padding='10px';
        d.appendChild(box);
        manageArea.appendChild(d);
      });
    }

    function addTemplate(cat, name){
      if(!name) return notify('Enter an exercise name','error');
      state.exercises[cat] = state.exercises[cat] || [];
      if(state.exercises[cat].some(e=>e.name.toLowerCase()===name.toLowerCase())){ return notify('Exercise already exists','error'); }
      state.exercises[cat].push(makeEx(name));
      save();
      notify('Exercise added','success');
    }

    // ====== Modal (Start Workout) ======
    const workoutModal = document.getElementById('workoutModal');
    const modalTitle = document.getElementById('modalTitle');
    const lastSessionInfo = document.getElementById('lastSessionInfo');
    const exerciseContainer = document.getElementById('exerciseContainer');
    const closeModalBtn = document.getElementById('closeModal');
    const addExerciseBtn = document.getElementById('addExerciseBtn');
    const newExerciseName = document.getElementById('newExerciseName');
    const modalDate = document.getElementById('modalDate');
    const saveWorkoutBtn = document.getElementById('saveWorkoutBtn');
    const deleteSessionBtn = document.getElementById('deleteSessionBtn');

    closeModalBtn.onclick = ()=> closeModal();
    addExerciseBtn.onclick = ()=>{
      const name = newExerciseName.value.trim();
      if(!name) return notify('Enter an exercise name','error');
      const ex = makeEx(name);
      state.exercises[ui.modalCategory].push(ex);
      ui.modalItems.push({ id: ex.id, name: ex.name, sets:[{},{},{}], note:'' });
      newExerciseName.value='';
      save();
      openModal(ui.modalCategory, modalDate.value);
      notify('Exercise added to session','success');
    };

    function openModal(category, dateKeyOpt){
      ui.modalCategory = category;
      modalTitle.textContent = `Start Workout â ${category}`;
      const dk = dateKeyOpt || dateKey(new Date());
      modalDate.value = dk;
      const existingToday = (state.workouts[dk]||[]).find(w=>w.category===category);
      if(existingToday){ ui.modalItems = clone(existingToday.items); }
      else{
        const templates = state.exercises[category] || [];
        const last = getLastSession(category, dk);
        lastSessionInfo.textContent = last ? `Last ${category} day: ${new Date(parseKey(last.date)).toLocaleDateString()} â ${last.items.length} exercise(s)` : `No past ${category} session found.`;
        ui.modalItems = templates.map(t=>{
          const found = last ? last.items.find(i=>i.name.toLowerCase()===t.name.toLowerCase()) : null;
          return { id: t.id, name: t.name, sets: found ? found.sets.map(s=>({weight:s.weight||'', reps:s.reps||''})) : [{},{},{}], note: found ? (found.note||'') : '' };
        });
      }
      renderModalItems();
      workoutModal.classList.add('open');
      workoutModal.setAttribute('aria-hidden','false');
    }

    function closeModal(){
      workoutModal.classList.remove('open');
      workoutModal.setAttribute('aria-hidden','true');
      ui.modalCategory = null; ui.modalItems = [];
    }

    function renderModalItems(){
      const last = getLastSession(ui.modalCategory, modalDate.value);
      lastSessionInfo.textContent = last ? `Last ${ui.modalCategory} day: ${new Date(parseKey(last.date)).toLocaleDateString()} â ${last.items.length} exercise(s)` : `No past ${ui.modalCategory} session found.`;
      exerciseContainer.innerHTML='';
      if(ui.modalItems.length===0){ const p=document.createElement('div'); p.className='muted'; p.textContent='No exercises. Add one above.'; exerciseContainer.appendChild(p); return; }
      ui.modalItems.forEach((it, idx)=>{
        const row=document.createElement('div'); row.className='exercise-row reveal';
        const head=document.createElement('div'); head.className='exercise-head';
        const left=document.createElement('div'); left.innerHTML = `<div class='exercise-name'>${it.name}</div>`; head.appendChild(left);
        const actions=document.createElement('div'); actions.className='row';
        const del=document.createElement('button'); del.className='btn danger small'; del.textContent='Remove'; del.onclick=()=>{ ui.modalItems.splice(idx,1); renderModalItems(); };
        actions.appendChild(del); head.appendChild(actions);
        row.appendChild(head);
        const sets=document.createElement('div'); sets.className='set-table';
        it.sets = it.sets && it.sets.length===3 ? it.sets : [{},{},{}];
        it.sets.forEach((s,i)=>{
          const cell=document.createElement('div'); cell.className='set-cell';
          const wWrap=document.createElement('div');
          const wLab=document.createElement('label'); wLab.textContent=`Set ${i+1} Â· Weight (kg)`; wWrap.appendChild(wLab);
          const w=document.createElement('input'); w.type='number'; w.min='0'; w.step='0.5'; w.value = s.weight ?? ''; w.oninput = (e)=>{ it.sets[i].weight = parseFloat(e.target.value)||''; };
          wWrap.appendChild(w);
          const rWrap=document.createElement('div');
          const rLab=document.createElement('label'); rLab.textContent=`Reps`; rWrap.appendChild(rLab);
          const r=document.createElement('input'); r.type='number'; r.min='0'; r.step='1'; r.value = s.reps ?? ''; r.oninput = (e)=>{ it.sets[i].reps = parseInt(e.target.value)||''; };
          rWrap.appendChild(r);
          cell.appendChild(wWrap); cell.appendChild(rWrap); sets.appendChild(cell);
        });
        row.appendChild(sets);
        const noteWrap=document.createElement('div'); noteWrap.style.marginTop='8px';
        const nLab=document.createElement('label'); nLab.textContent='Note (optional)'; noteWrap.appendChild(nLab);
        const n=document.createElement('textarea'); n.rows=2; n.placeholder='Any cues, form reminders, tempo, etc.'; n.value=it.note||''; n.oninput=(e)=>{ it.note = e.target.value; };
        noteWrap.appendChild(n); row.appendChild(noteWrap);
        exerciseContainer.appendChild(row);
      });
    }

    saveWorkoutBtn.onclick = ()=>{
      if(!ui.modalCategory) return;
      const dk = modalDate.value;
      const hasData = ui.modalItems.some(it=> it.sets.some(s=> (s.weight||s.reps) ));
      if(!hasData){ return notify('Enter at least one set','error'); }
      const payload = { category: ui.modalCategory, items: ui.modalItems.map(it=>({ id: it.id, name: it.name, sets: it.sets.map(s=>({weight: s.weight||0, reps: s.reps||0})), note: it.note||'' })) };
      const arr = state.workouts[dk] = state.workouts[dk] || [];
      const idx = arr.findIndex(w=>w.category===ui.modalCategory);
      if(idx>=0){ if(!confirm('A session for this group already exists on this date. Replace it?')) return; arr[idx] = payload; }
      else arr.push(payload);
      save();
      notify('Workout saved','success');
      closeModal();
    };

    deleteSessionBtn.onclick = ()=>{
      if(!ui.modalCategory) return;
      const dk = modalDate.value;
      const arr = state.workouts[dk]||[];
      const idx = arr.findIndex(w=>w.category===ui.modalCategory);
      if(idx>=0){ if(confirm('Delete this session?')){ arr.splice(idx,1); if(arr.length===0) delete state.workouts[dk]; save(); notify('Session deleted','success'); closeModal(); } }
    };

    function getLastSession(category, beforeOrOnDateKey){
      const keys = Object.keys(state.workouts).filter(k=> k<=beforeOrOnDateKey);
      keys.sort();
      for(let i=keys.length-1;i>=0;i--){ const arr=state.workouts[keys[i]]; const found = arr.find(w=>w.category===category); if(found) return { date: keys[i], items: clone(found.items) }; }
      return null;
    }

    // ====== Quick Add ======
    document.getElementById('addQuickBtn').onclick = ()=>{
      const cat = prompt('Muscle group (Chest, Back, Arms, Shoulders, Legs, Forearms):');
      if(!cat || !CATEGORIES.includes(cap(cat))) return notify('Invalid group','error');
      openModal(cap(cat), ui.selectedDate);
    };

    // ====== Export / Import / Reset ======
    document.getElementById('exportBtn').onclick = ()=>{
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `workout-backup-${Date.now()}.json`; a.click();
      URL.revokeObjectURL(url);
      notify('Exported backup','success');
    };
    document.getElementById('importFile').onchange = (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader(); reader.onload = ()=>{
        try{ const data = JSON.parse(reader.result); if(!data.exercises||!data.workouts) throw new Error('Invalid'); state = data; save(); notify('Imported successfully','success'); }
        catch(err){ notify('Failed to import: '+err.message,'error'); }
      }; reader.readAsText(file);
    };
    document.getElementById('resetBtn').onclick = ()=>{ if(confirm('This will permanently erase all local data. Continue?')){ state = initialState(); save(); notify('Data reset','success'); } };

    // ====== GitHub Sync (optional) ======
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeSettings = document.getElementById('closeSettings');
    const saveSettingsBtn = document.getElementById('saveSettings');
    const loadFromGitHubBtn = document.getElementById('loadFromGitHub');
    const syncBtn = document.getElementById('syncBtn');

    settingsBtn.onclick = ()=> openSettings();
    closeSettings.onclick = ()=> closeSettingsModal();
    saveSettingsBtn.onclick = ()=> handleSaveSettings();
    loadFromGitHubBtn.onclick = ()=> loadFromGitHub();
    syncBtn.onclick = ()=> syncNow();

    function openSettings(){
      const els = domSettings();
      els.owner.value = settings.owner||'';
      els.repo.value = settings.repo||'';
      els.branch.value = settings.branch||'main';
      els.path.value = settings.path||'backup.json';
      els.token.value = getToken();
      els.auto.value = settings.auto||'off';
      settingsModal.classList.add('open');
      settingsModal.setAttribute('aria-hidden','false');
    }
    function closeSettingsModal(){ settingsModal.classList.remove('open'); settingsModal.setAttribute('aria-hidden','true'); }
    function domSettings(){
      return {
        owner: document.getElementById('ghOwner'),
        repo: document.getElementById('ghRepo'),
        branch: document.getElementById('ghBranch'),
        path: document.getElementById('ghPath'),
        token: document.getElementById('ghToken'),
        auto: document.getElementById('ghAuto'),
      }
    }
    function handleSaveSettings(){
      const els = domSettings();
      settings = { owner: (els.owner.value||'').trim(), repo: (els.repo.value||'').trim(), branch: (els.branch.value||'main').trim(), path: (els.path.value||'backup.json').trim(), auto: els.auto.value };
      saveSettings(settings);
      setToken((els.token.value||'').trim());
      notify('Settings saved','success');
      closeSettingsModal();
    }

    function maybeAutoSync(){ if(settings.auto==='on'){ syncNow({quiet:true}); } }

    async function syncNow(opts={}){
      try{
        const token = getToken();
        if(!settings.owner||!settings.repo||!settings.branch||!settings.path) throw new Error('Missing repo settings');
        if(!token) throw new Error('Missing token');
        const content = JSON.stringify(state, null, 2);
        await githubUpsertFile({owner:settings.owner, repo:settings.repo, branch:settings.branch, path:settings.path, token}, content, `Workout backup ${new Date().toISOString()}`);
        if(!opts.quiet) notify('Synced to GitHub','success');
      }catch(err){ if(!opts.quiet) notify('Sync failed: '+err.message,'error'); }
    }

    async function loadFromGitHub(){
      try{
        if(!settings.owner||!settings.repo||!settings.branch||!settings.path) throw new Error('Missing repo settings');
        const url = `https://raw.githubusercontent.com/${encodeURIComponent(settings.owner)}/${encodeURIComponent(settings.repo)}/${encodeURIComponent(settings.branch)}/${settings.path}`;
        const res = await fetch(url, {cache:'no-store'});
        if(!res.ok) throw new Error('Failed to fetch: '+res.status);
        const data = await res.json();
        if(!data.exercises||!data.workouts) throw new Error('Invalid backup file');
        state = data; save(); notify('Loaded from GitHub','success');
        closeSettingsModal();
      }catch(err){ notify('Load failed: '+err.message,'error'); }
    }

    async function githubUpsertFile({owner, repo, branch, path, token}, content, message){
      const apiBase = 'https://api.github.com';
      const headers = { 'Accept':'application/vnd.github+json', 'Authorization': `Bearer ${token}` };
      let sha = null;
      const getRes = await fetch(`${apiBase}/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`, { headers });
      if(getRes.status===200){ const info = await getRes.json(); sha = info.sha; }
      else if(getRes.status!==404){ throw new Error('Read error '+getRes.status); }
      const body = { message, content: b64(content), branch };
      if(sha) body.sha = sha;
      const putRes = await fetch(`${apiBase}/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`, { method:'PUT', headers: {...headers, 'Content-Type':'application/json'}, body: JSON.stringify(body) });
      if(!putRes.ok){ const t = await putRes.text(); throw new Error('Write error '+putRes.status+': '+t); }
      return true;
    }

    function b64(str){ return btoa(unescape(encodeURIComponent(str))); }

    // ====== Ripple effect on buttons ======
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.btn');
      if(!btn) return;
      const rect = btn.getBoundingClientRect();
      const ripple = document.createElement('span');
      const size = Math.max(rect.width, rect.height);
      ripple.style.position='absolute';
      ripple.style.left = (e.clientX - rect.left - size/2)+'px';
      ripple.style.top = (e.clientY - rect.top - size/2)+'px';
      ripple.style.width = ripple.style.height = size+'px';
      ripple.style.borderRadius='999px';
      ripple.style.background='rgba(255,255,255,.5)';
      ripple.style.pointerEvents='none';
      ripple.style.transform='scale(0)';
      ripple.style.opacity='.35';
      ripple.style.transition='transform .6s var(--ease), opacity .6s var(--ease)';
      btn.appendChild(ripple);
      requestAnimationFrame(()=>{ ripple.style.transform='scale(2.4)'; ripple.style.opacity='0'; });
      setTimeout(()=>ripple.remove(), 650);
    });

    // ====== Toasts ======
    const toastBox = document.getElementById('toasts');
    function notify(msg, type='success'){
      const t = document.createElement('div');
      t.className = 'toast '+type; t.textContent = msg;
      toastBox.appendChild(t);
      requestAnimationFrame(()=> t.classList.add('show'));
      setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(), 220); }, 2200);
    }

    // ====== Render root ======
    function renderAll(){ renderCategories(); renderCalendar(); renderDay(); renderManage(); }

    // boot
    renderAll();
  </script>
</body>
</html>
